<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stock Manager Futuristic - Simetris & Lengkap</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
body { background: linear-gradient(145deg,#a0c4ff,#bdb2ff,#ffc6ff); font-family:'Inter',sans-serif; margin-bottom:90px; }
.card { border-radius:20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); box-shadow:0 6px 18px rgba(0,0,0,0.15); transition: transform 0.3s, box-shadow 0.3s; margin-bottom:20px; }
.card:hover { transform:translateY(-3px); box-shadow:0 10px 28px rgba(0,0,0,0.3); }
.table th { background-color: rgba(200,200,200,0.3); text-align:center; }
.section { display:none; padding:15px; animation: fadeIn 0.5s ease;}
.show { display:block; }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

.bottom-nav { position: fixed; bottom:0; width:100%; height:65px; background-color: rgba(255,255,255,0.95); display:flex; justify-content:space-around; align-items:center; border-top:1px solid #ccc; z-index:999;}
.bottom-nav button { background:none; border:none; flex-direction:column; font-size:12px; color:#555; display:flex; align-items:center; }
.bottom-nav button.active { color:#0d6efd; font-weight:bold; }
.bottom-nav i { font-size:22px; margin-bottom:2px; }

.filter-btn { margin-right:5px; }
.filter-btn.active { background:#0d6efd; color:#fff; }

.btn-gradient { background:linear-gradient(90deg,#00ffcc,#0099ff); color:#000; font-weight:bold; }

.total-box { font-size:18px; font-weight:bold; color:#198754; text-align:center; }
</style>
</head>
<body>

<div class="container py-3">

<h2 class="text-center mb-4">ðŸ“¦ Stock Barang Ku</h2>

<!-- Tambah Produk -->
<div class="section card p-3" id="addProduct">
<h5>Tambah / Edit Produk</h5>
<form id="productForm">
<input type="hidden" id="editIndex">
<div class="mb-2"><input type="text" id="productName" class="form-control" placeholder="Nama Barang" required></div>
<div class="mb-2"><input type="number" id="productPrice" class="form-control" placeholder="Harga" required min="0"></div>
<div class="mb-2"><input type="number" id="productStock" class="form-control" placeholder="Stok Awal" required min="0"></div>
<button type="submit" class="btn w-100 btn-gradient">Simpan Produk</button>
</form>
</div>

<!-- Catat Penjualan -->
<div class="section card p-3" id="saleProduct">
<h5>Catat Penjualan</h5>
<form id="saleForm">
<div class="mb-2"><input type="text" id="buyerName" class="form-control" placeholder="Nama Pembeli" required></div>
<div class="mb-2"><select id="productSelect" class="form-select"></select></div>
<div class="mb-2"><input type="number" id="qty" class="form-control" placeholder="Jumlah Memesan" required min="1"></div>
<button type="submit" class="btn w-100 btn-gradient">Catat Penjualan</button>
</form>
</div>

<!-- Daftar Produk -->
<div class="section card p-3" id="productList">
<h5>Daftar Produk</h5>
<div class="table-responsive">
<table class="table table-bordered text-center">
<thead><tr><th>Nama</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr></thead>
<tbody id="productTable"></tbody>
</table>
</div>
</div>

<!-- History & Chart -->
<div class="section" id="historyChart">
<div class="card p-3">
<h5>Riwayat Transaksi (5 Terbaru)</h5>
<div class="table-responsive">
<table class="table table-striped text-center">
<thead><tr><th>Waktu</th><th>Pembeli</th><th>Produk</th><th>Jumlah</th><th>Total</th></tr></thead>
<tbody id="historyTable"></tbody>
</table>
</div>
<button class="btn btn-sm btn-primary mt-2" onclick="openModal()">Lihat Semua Riwayat & Laba/Rugi</button>
</div>

<div class="card p-3">
<h5>Barang Dalam Proses / Order</h5>
<div class="mb-2">
<button class="btn btn-sm btn-outline-primary filter-btn active" onclick="filterOrders('pending', this)">Memesan</button>
<button class="btn btn-sm btn-outline-success filter-btn" onclick="filterOrders('sold', this)">Terjual</button>
<button class="btn btn-sm btn-outline-danger filter-btn" onclick="filterOrders('canceled', this)">Batal Beli</button>
</div>
<div class="table-responsive">
<table class="table table-bordered text-center">
<thead><tr><th>Produk</th><th>Pembeli</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr></thead>
<tbody id="orderTable"></tbody>
</table>
</div>
</div>

<div class="card p-3">
<h5>ðŸ“Š Grafik Penjualan</h5>
<div class="row mb-2">
<div class="col-md-3"><input type="date" id="chartStart" class="form-control"></div>
<div class="col-md-3"><input type="date" id="chartEnd" class="form-control"></div>
</div>
<canvas id="salesChart"></canvas>
</div>

</div>

<!-- Modal Riwayat Lengkap -->
<div class="modal fade" id="historyModal" tabindex="-1">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Riwayat Lengkap Transaksi & Laba/Rugi</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="row mb-3">
<div class="col-md-3"><input type="date" id="startDate" class="form-control"></div>
<div class="col-md-3"><input type="date" id="endDate" class="form-control"></div>
</div>
<div class="mb-3 text-center">
<div class="row">
<div class="col total-box"><strong>Total Pendapatan:</strong> Rp <span id="modalRevenue">0</span></div>
<div class="col total-box"><strong>Total Refund:</strong> Rp <span id="modalRefund">0</span></div>
<div class="col total-box"><strong>Laba/Rugi Bersih:</strong> Rp <span id="modalNet">0</span></div>
</div>
</div>
<table class="table table-striped text-center" id="fullHistoryTable">
<thead><tr><th>Waktu</th><th>Pembeli</th><th>Produk</th><th>Jumlah</th><th>Total</th><th>Status</th><th>Refund</th><th>Aksi</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
<button onclick="switchTab('addProduct',this)" class="active"><i class="bi bi-plus-circle"></i>Tambah</button>
<button onclick="switchTab('saleProduct',this)"><i class="bi bi-cart-check"></i>Jual</button>
<button onclick="switchTab('productList',this)"><i class="bi bi-box-seam"></i>Produk</button>
<button onclick="switchTab('historyChart',this)"><i class="bi bi-bar-chart"></i>Riwayat</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ========== STATE ==========
const state = {
    products: JSON.parse(localStorage.getItem("products")) || [],
    orders: JSON.parse(localStorage.getItem("orders")) || [],
    history: JSON.parse(localStorage.getItem("history")) || [],
    refunds: JSON.parse(localStorage.getItem("refunds")) || []
};
let chart;
let currentFilter = "pending";

function save(){
    localStorage.setItem("products", JSON.stringify(state.products));
    localStorage.setItem("orders", JSON.stringify(state.orders));
    localStorage.setItem("history", JSON.stringify(state.history));
    localStorage.setItem("refunds", JSON.stringify(state.refunds));
}

// ========== TAB & FILTER ==========
function switchTab(id, btn){
    document.querySelectorAll(".section").forEach(s => s.classList.remove("show"));
    document.getElementById(id).classList.add("show");
    document.querySelectorAll(".bottom-nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
}
function filterOrders(status, btn){
    currentFilter = status;
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    render();
}

// ========== RENDER ==========
function render(){
    const productTable = document.getElementById("productTable");
    const productSelect = document.getElementById("productSelect");
    const historyTable = document.getElementById("historyTable");
    const orderTable = document.getElementById("orderTable");
    productTable.innerHTML = ""; productSelect.innerHTML = ""; historyTable.innerHTML = ""; orderTable.innerHTML = "";

    // Produk
    state.products.forEach((p,i)=>{
        productTable.innerHTML += `<tr>
            <td>${p.name}</td><td>Rp ${p.price.toLocaleString()}</td><td>${p.stock}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editProduct(${i})">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteProduct(${i})">Hapus</button>
            </td>
        </tr>`;
        productSelect.innerHTML += `<option value="${i}">${p.name}</option>`;
    });

    // History 5 terakhir
    state.history.slice(0,5).forEach(h=>{
        historyTable.innerHTML += `<tr>
            <td>${h.time}</td><td>${h.buyer}</td><td>${h.name}</td><td>${h.qty}</td><td>Rp ${h.total.toLocaleString()}</td>
        </tr>`;
    });

    // Orders
    state.orders.map((o,i)=>({...o,index:i})).filter(o=>o.status===currentFilter).forEach(o=>{
        let badge = o.status==="pending"?'<span class="badge bg-primary">Memesan</span>':o.status==="sold"?'<span class="badge bg-success">Terjual</span>':'<span class="badge bg-danger">Batal Beli</span>';
        orderTable.innerHTML += `<tr>
            <td>${o.name}</td><td>${o.buyer}</td><td>${o.qty}</td><td>${badge}</td>
            <td>${o.status==="pending"?`<button class="btn btn-success btn-sm" onclick="markSold(${o.index})">Terjual</button>
            <button class="btn btn-danger btn-sm" onclick="markCanceled(${o.index})">Batal</button>`:"-"}</td>
        </tr>`;
    });

    updateChart();
}

// ========== MARK TERJUAL / BATAL ==========
function markSold(i){
    const o = state.orders[i];
    o.status = "sold";
    o.total = o.total || o.qty*state.products.find(p=>p.name===o.name)?.price||0;
    save(); render();
}
function markCanceled(i){
    const o = state.orders[i];
    const cancelQty = parseInt(prompt(`Jumlah batal beli (max ${o.qty})`, o.qty));
    if(isNaN(cancelQty)||cancelQty<1) return;
    const actualCancel = Math.min(cancelQty,o.qty);
    const prod = state.products.find(p=>p.name===o.name);
    if(prod) prod.stock += actualCancel;
    state.refunds.unshift({time:new Date().toLocaleString(),buyer:o.buyer,product:o.name,qty:actualCancel,nominal:actualCancel*(prod?prod.price:0)});
    o.qty -= actualCancel;
    if(o.qty===0) o.status="canceled";
    save(); render();
}

// ========== FORM PRODUK ==========
document.getElementById("productForm").onsubmit=function(e){
    e.preventDefault();
    const name = document.getElementById("productName").value.trim();
    const price = parseInt(document.getElementById("productPrice").value);
    const stock = parseInt(document.getElementById("productStock").value);
    const editIndex = document.getElementById("editIndex").value;
    if(editIndex==="") state.products.push({name,price,stock});
    else state.products[editIndex]={name,price,stock};
    this.reset(); document.getElementById("editIndex").value="";
    save(); render();
}

// ========== FORM JUAL ==========
document.getElementById("saleForm").onsubmit=function(e){
    e.preventDefault();
    const i = productSelect.value;
    const qty = parseInt(document.getElementById("qty").value);
    const buyer = document.getElementById("buyerName").value.trim();
    if(state.products[i].stock < qty){alert("Stok tidak cukup!"); return;}
    state.products[i].stock -= qty;
    const total = state.products[i].price*qty;
    state.history.unshift({time:new Date().toLocaleString(),buyer,name:state.products[i].name,qty,total});
    state.orders.unshift({buyer,name:state.products[i].name,qty,status:"pending",total});
    this.reset(); document.getElementById("qty").value=1;
    save(); render();
}

// ========== EDIT / DELETE ==========
function editProduct(i){
    const p = state.products[i];
    document.getElementById("productName").value = p.name;
    document.getElementById("productPrice").value = p.price;
    document.getElementById("productStock").value = p.stock;
    document.getElementById("editIndex").value = i;
    switchTab('addProduct',document.querySelectorAll(".bottom-nav button")[0]);
}
function deleteProduct(i){
    if(confirm("Hapus produk ini?")){
        state.products.splice(i,1);
        save(); render();
    }
}

// ========== CHART ==========
document.getElementById("chartStart").addEventListener("change",updateChart);
document.getElementById("chartEnd").addEventListener("change",updateChart);
function updateChart(){
    const start=document.getElementById("chartStart").value;
    const end=document.getElementById("chartEnd").value;
    let filtered=state.orders.filter(o=>o.status==="sold");
    if(start) filtered = filtered.filter(o=>new Date(o.time)>=new Date(start));
    if(end) filtered = filtered.filter(o=>new Date(o.time)<=new Date(end+"T23:59:59"));
    const dataCount={};
    filtered.forEach(o=>{dataCount[o.name]=(dataCount[o.name]||0)+o.qty;});
    const labels=Object.keys(dataCount); const data=Object.values(dataCount);
    if(chart) chart.destroy();
    chart=new Chart(document.getElementById("salesChart"),{type:"bar",data:{labels,datasets:[{label:"Terjual",data,backgroundColor:"rgba(0,255,204,0.7)"}]},options:{responsive:true}});
}

// ========== MODAL RIWAYAT ==========
function openModal(){ renderModal(state.history); new bootstrap.Modal(document.getElementById("historyModal")).show(); }
function renderModal(data){
    const tbody=document.querySelector("#fullHistoryTable tbody");
    tbody.innerHTML=""; let totalRevenue=0,totalRefund=0;
    data.forEach((h,i)=>{
        let order=state.orders.find(o=>o.buyer===h.buyer && o.name===h.name);
        let status=order?order.status==="pending"?"Memesan":order.status==="sold"?"Terjual":"Batal Beli":"-";
        let refundEntry=state.refunds.find(r=>r.buyer===h.buyer && r.product===h.name);
        let refundText=refundEntry?`${refundEntry.qty} pcs / Rp ${refundEntry.nominal.toLocaleString()}`:"-";
        if(status==="Terjual") totalRevenue+=h.total||0;
        if(refundEntry) totalRefund+=refundEntry.nominal;
        tbody.innerHTML+=`<tr>
            <td>${h.time}</td><td>${h.buyer}</td><td>${h.name}</td><td>${h.qty}</td><td>Rp ${h.total.toLocaleString()}</td><td>${status}</td><td>${refundText}</td>
            <td>${status==="Memesan"?`<button class="btn btn-sm btn-danger" onclick="markCanceled(${i})">Batal</button>`:"-"}</td>
        </tr>`;
    });
    document.getElementById("modalRevenue").textContent=totalRevenue.toLocaleString();
    document.getElementById("modalRefund").textContent=totalRefund.toLocaleString();
    document.getElementById("modalNet").textContent=(totalRevenue-totalRefund).toLocaleString();
}

document.getElementById("startDate").addEventListener("change",filterModalDate);
document.getElementById("endDate").addEventListener("change",filterModalDate);
function filterModalDate(){
    const start=document.getElementById("startDate").value;
    const end=document.getElementById("endDate").value;
    let filtered=state.history;
    if(start) filtered=filtered.filter(h=>new Date(h.time)>=new Date(start));
    if(end) filtered=filtered.filter(h=>new Date(h.time)<=new Date(end+"T23:59:59"));
    renderModal(filtered);
}

// INITIAL
switchTab('addProduct',document.querySelectorAll(".bottom-nav button")[0]);
render();
</script>

</body>
</html>
