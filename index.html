<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StockPro - Dashboard Lengkap</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style> 
:root{
--bg:#f6f9fc;
--sidebar:#111827;
--card:#ffffff;
--primary:#4f46e5;
--text:#1f2937;
--muted:#6b7280;
}
body{margin:0;background:var(--bg);font-family:'Inter',sans-serif;color:var(--text);}
.wrapper{display:flex;min-height:100vh;}
.sidebar{
width:220px;background:var(--sidebar);color:#fff;
padding:25px 18px;display:flex;flex-direction:column;justify-content:space-between;
}
.sidebar h4{font-weight:600;margin-bottom:30px;}
.sidebar .menu a{
display:flex;align-items:center;gap:12px;
padding:11px 12px;border-radius:12px;
color:#cbd5e1;text-decoration:none;margin-bottom:8px;
transition:0.2s;font-size:14px;
}
.sidebar .menu a:hover{background:rgba(255,255,255,0.08);color:#fff;}
.sidebar .menu a.active{background:var(--primary);color:#fff;}
.main{flex:1;display:flex;flex-direction:column;}
.topbar{
height:70px;background:#fff;display:flex;
align-items:center;justify-content:space-between;
padding:0 30px;box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
.topbar h5{margin:0;font-weight:600;}
.content{padding:30px;overflow-y:auto;}

/* Dashboard Cards */
.dashboard-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:25px;}
.card-dashboard{border-radius:20px;background:#fff;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.05);transition:0.2s;display:flex;justify-content:space-between;align-items:center;}
.card-dashboard:hover{transform:translateY(-3px);box-shadow:0 14px 40px rgba(0,0,0,0.08);}
.card-dashboard h3{margin:0;font-weight:700;}
.card-dashboard small{color:var(--muted);}
.card-dashboard i{font-size:28px;opacity:0.3;}

/* Top Selling & Low Stock */
.top-list{margin-top:20px;}
.top-list h6{margin-bottom:10px;font-weight:600;}
.top-list ul{list-style:none;padding-left:0;margin:0;max-height:150px;overflow-y:auto;}
.top-list ul li{padding:8px 12px;border-radius:8px;background:#f8fafc;margin-bottom:5px;display:flex;justify-content:space-between;align-items:center;font-size:14px;border:1px solid #e2e8f0;}

/* Forms & tables */
.saas-card{background:var(--card);border-radius:20px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.05);margin-bottom:25px;}
.table th{text-align:center;background:#f8fafc !important;}
.table td{text-align:center;vertical-align:middle;}
.table-responsive-scroll{max-height:300px;overflow-y:auto;}
.filter-btn{margin-right:5px;transition:0.2s;}
.filter-btn.active{background:var(--primary);color:#fff;}
.btn-gradient{background: linear-gradient(90deg,#4f46e5,#3b82f6); color:#fff; font-weight:bold; transition:0.3s;}

/* History Table */
.history-card{border-radius:15px;background:#fff;padding:20px;margin-top:25px;box-shadow:0 8px 25px rgba(0,0,0,0.05);}
.history-filters{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;align-items:end;}

/* Dark mode */
.dark{--bg:#0f172a;--sidebar:#0b1220;--card:#1e293b;--text:#f1f5f9;--muted:#94a3b8;}
.dark .topbar{background:#1e293b;color:#fff;}
.dark .saas-card,.dark .history-card,.dark .card-dashboard:not(.text-white){background:#1e293b;color:#f1f5f9;}
.dark .top-list ul li{background:#334155;border-color:#475569;color:#f1f5f9;}
</style>
</head>
<body>
<div class="wrapper">
<div class="sidebar">
<div>
<h4>StockPro</h4>
<div class="menu">
<a href="#" class="active" data-page="dashboardPage"><i class="bi bi-grid"></i> Dashboard</a>
<a href="#" data-page="addProduct"><i class="bi bi-plus-circle"></i> Tambah Produk</a>
<a href="#" data-page="saleProduct"><i class="bi bi-cart-check"></i> Catat Penjualan</a>
<a href="#" data-page="orderPage"><i class="bi bi-hourglass-split"></i> Order</a>
<a href="#" data-page="productList"><i class="bi bi-box-seam"></i> Daftar Produk</a>
</div>
</div>
<small style="color:#94a3b8;">Â© 2026 StockPro</small>
</div>

<div class="main">
<div class="topbar">
<h5 id="pageTitle">Dashboard</h5>
<div>
<span id="todayDate"></span>
<i class="bi bi-moon toggle-dark ms-3" onclick="document.body.classList.toggle('dark')" style="cursor:pointer;"></i>
</div>
</div>

<div class="content">

<div class="page" id="dashboardPage">
<div class="dashboard-cards">
<div class="card-dashboard bg-primary text-white">
<div>
<small>Total Omzet</small>
<h3 id="kpiRevenue">Rp 0</h3>
</div>
<i class="bi bi-cash-coin"></i>
</div>
<div class="card-dashboard bg-info text-white">
<div>
<small>Estimasi Laba Bersih</small>
<h3 id="kpiProfit">Rp 0</h3>
</div>
<i class="bi bi-graph-up-arrow"></i>
</div>
<div class="card-dashboard bg-success text-white">
<div>
<small>Varian Produk</small>
<h3 id="kpiProducts">0</h3>
</div>
<i class="bi bi-box"></i>
</div>
<div class="card-dashboard bg-warning text-dark">
<div>
<small>Order Memesan</small>
<h3 id="kpiPending">0</h3>
</div>
<i class="bi bi-cart"></i>
</div>
</div>

<div class="saas-card">
<div class="row">
<div class="col-md-6 top-list">
<h6><i class="bi bi-fire text-danger"></i> Produk Terlaris</h6>
<ul id="topSelling"></ul>
</div>
<div class="col-md-6 top-list">
<h6><i class="bi bi-exclamation-octagon text-warning"></i> Stok Rendah (< 5)</h6>
<ul id="lowStock"></ul>
</div>
</div>
</div>

<div class="history-card">
<h5>Riwayat Transaksi Terakhir</h5>
<div class="history-filters">
<div>
<label class="small text-muted">Mulai:</label>
<input type="date" id="filterStart" class="form-control form-control-sm">
</div>
<div>
<label class="small text-muted">Sampai:</label>
<input type="date" id="filterEnd" class="form-control form-control-sm">
</div>
<div>
<label class="small text-muted">Produk:</label>
<select id="filterProduct" class="form-select form-select-sm">
<option value="">Semua Produk</option>
</select>
</div>
<button class="btn btn-sm btn-primary" onclick="renderHistory()"><i class="bi bi-search"></i> Cari</button>
<button class="btn btn-sm btn-success" onclick="exportExcel()"><i class="bi bi-file-earmark-excel"></i> Excel</button>
</div>
<div class="table-responsive table-responsive-scroll">
<table class="table table-bordered table-hover">
<thead>
<tr><th>Waktu</th><th>Pembeli</th><th>Produk</th><th>Jumlah</th><th>Total</th><th>Aksi</th></tr>
</thead>
<tbody id="historyTable"></tbody>
</table>
</div>
</div>
</div>

<div class="page d-none" id="addProduct">
<div class="saas-card">
<h5>Tambah / Edit Produk</h5>
<form id="productForm">
<input type="hidden" id="editIndex">
<div class="mb-2"><input type="text" id="productName" class="form-control" placeholder="Nama Barang" required></div>
<div class="mb-2"><input type="number" id="productCost" class="form-control" placeholder="Harga Modal (Rp)" required min="0"></div>
<div class="mb-2"><input type="number" id="productPrice" class="form-control" placeholder="Harga Jual (Rp)" required min="0"></div>
<div class="mb-2"><input type="number" id="productStock" class="form-control" placeholder="Stok Awal" required min="0"></div>
<button type="submit" class="btn w-100 btn-gradient">Simpan Produk</button>
</form>
</div>
</div>

<div class="page d-none" id="saleProduct">
<div class="saas-card">
<h5>Catat Penjualan</h5>
<form id="saleForm">
<div class="mb-2"><input type="text" id="buyerName" class="form-control" placeholder="Nama Pembeli" required></div>
<div class="mb-2"><select id="productSelect" class="form-select" required></select></div>
<div class="mb-2"><input type="number" id="qty" class="form-control" placeholder="Jumlah Memesan" required min="1"></div>
<button type="submit" class="btn w-100 btn-gradient">Catat Penjualan</button>
</form>
</div>
</div>

<div class="page d-none" id="orderPage">
<div class="saas-card">
<h5>Konfirmasi Order</h5>
<div class="mb-2">
<button class="btn btn-sm btn-outline-primary filter-btn active" onclick="filterOrders('pending', this)">Memesan</button>
<button class="btn btn-sm btn-outline-success filter-btn" onclick="filterOrders('sold', this)">Terjual</button>
<button class="btn btn-sm btn-outline-danger filter-btn" onclick="filterOrders('canceled', this)">Batal Beli</button>
</div>
<div class="table-responsive">
<table class="table table-bordered text-center">
<thead><tr><th>Produk</th><th>Pembeli</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr></thead>
<tbody id="orderTable"></tbody>
</table>
</div>
</div>
</div>

<div class="page d-none" id="productList">
<div class="saas-card">
<h5>Daftar Inventaris</h5>
<div class="table-responsive">
<table class="table table-bordered text-center">
<thead><tr><th>Nama</th><th>Modal</th><th>Jual</th><th>Stok</th><th>Aksi</th></tr></thead>
<tbody id="productTable"></tbody>
</table>
</div>
</div>
</div>

</div>
</div>
</div>

<div class="toast-container">
<div id="toastNotif" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="toast-header">
    <strong class="me-auto">StockPro</strong>
    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
  </div>
  <div class="toast-body" id="toastBody"></div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ===== STATE MANAGEMENT =====
const state={
    products: JSON.parse(localStorage.getItem("products")) || [],
    orders: JSON.parse(localStorage.getItem("orders")) || []
};
function save(){
    localStorage.setItem("products", JSON.stringify(state.products));
    localStorage.setItem("orders", JSON.stringify(state.orders));
}

// ===== NOTIFICATION =====
function showToast(msg){
  document.getElementById("toastBody").textContent=msg;
  const toastEl=document.getElementById("toastNotif");
  const toast=new bootstrap.Toast(toastEl);
  toast.show();
}

// ===== RENDER UTAMA =====
function render(){
    const productTable=document.getElementById("productTable");
    const productSelect=document.getElementById("productSelect");
    const topSelling=document.getElementById("topSelling");
    const lowStock=document.getElementById("lowStock");
    const filterProduct=document.getElementById("filterProduct");

    // Clear UI
    productTable.innerHTML=""; productSelect.innerHTML=""; topSelling.innerHTML=""; lowStock.innerHTML=""; filterProduct.innerHTML='<option value="">Semua Produk</option>';

    // 1. Hitung Penjualan untuk Top Selling
    const salesCount = {};
    state.orders.filter(o => o.status === "sold").forEach(o => {
        salesCount[o.name] = (salesCount[o.name] || 0) + o.qty;
    });

    // 2. Render Products & Cek Low Stock
    state.products.forEach((p,i)=>{
      let rowColor = p.stock === 0 ? 'table-danger' : (p.stock <= 5 ? 'table-warning' : '');
      productTable.innerHTML+=`<tr class="${rowColor}">
        <td>${p.name}</td>
        <td>Rp ${(p.cost || 0).toLocaleString()}</td>
        <td>Rp ${p.price.toLocaleString()}</td>
        <td><strong>${p.stock}</strong></td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="editProduct(${i})"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-danger btn-sm" onclick="deleteProduct(${i})"><i class="bi bi-trash"></i></button>
        </td>
      </tr>`;
      
      productSelect.innerHTML+=`<option value="${i}">${p.name}</option>`;
      filterProduct.innerHTML+=`<option value="${p.name}">${p.name}</option>`;
      
      if(p.stock <= 5) {
        lowStock.innerHTML+=`<li><span>${p.name}</span> <span class="badge bg-danger">${p.stock}</span></li>`;
      }
    });

    if(lowStock.innerHTML === "") lowStock.innerHTML = "<li class='text-muted small'>Stok semua produk aman</li>";

    // 3. Render Top Selling
    const sortedTop = Object.entries(salesCount).sort((a,b) => b[1] - a[1]).slice(0, 5);
    if(sortedTop.length === 0) {
        topSelling.innerHTML = "<li class='text-muted small'>Belum ada penjualan terjual</li>";
    } else {
        sortedTop.forEach(([name, qty]) => {
            topSelling.innerHTML += `<li><span>${name}</span> <span class="badge bg-success">${qty} Terjual</span></li>`;
        });
    }

    // 4. Update KPI
    const soldOrders = state.orders.filter(o => o.status === "sold");
    const revenue = soldOrders.reduce((sum, o) => sum + o.total, 0);
    const profit = soldOrders.reduce((sum, o) => {
        const prod = state.products.find(p => p.name === o.name);
        const modal = prod ? (prod.cost || 0) : 0;
        return sum + (o.total - (modal * o.qty));
    }, 0);

    document.getElementById("kpiProducts").textContent=state.products.length;
    document.getElementById("kpiPending").textContent=state.orders.filter(o=>o.status==="pending").length;
    document.getElementById("kpiRevenue").textContent="Rp "+revenue.toLocaleString();
    document.getElementById("kpiProfit").textContent="Rp "+profit.toLocaleString();

    renderHistory();
}

// ===== HISTORY & FILTER TANGGAL =====
function renderHistory(){
    const historyTable=document.getElementById("historyTable");
    const startVal = document.getElementById("filterStart").value;
    const endVal = document.getElementById("filterEnd").value;
    const productFilter=document.getElementById("filterProduct").value;

    const startDate = startVal ? new Date(startVal + "T00:00:00").getTime() : 0;
    const endDate = endVal ? new Date(endVal + "T23:59:59").getTime() : Date.now();

    historyTable.innerHTML="";
    const filtered = state.orders.slice().reverse().filter(o => {
        const matchTime = o.time >= startDate && o.time <= endDate;
        const matchProduct = productFilter === "" || o.name === productFilter;
        return matchTime && matchProduct;
    });

    filtered.forEach((o, i) => {
        let undoBtn=(Date.now() - o.time < 300000 && o.status === "pending") ? `<button class="btn btn-sm btn-outline-warning" onclick="undoOrder(${state.orders.indexOf(o)})">Undo</button>` : "";
        historyTable.innerHTML+=`<tr>
            <td style="font-size:12px">${new Date(o.time).toLocaleString('id-ID')}</td>
            <td>${o.buyer || '-'}</td>
            <td>${o.name}</td>
            <td>${o.qty}</td>
            <td>Rp ${o.total.toLocaleString()}</td>
            <td>${undoBtn}</td>
        </tr>`;
    });
}

// ===== EXCEL EXPORT =====
function exportExcel(){
    let wb=XLSX.utils.book_new();
    let ws_data=[["Waktu","Pembeli","Produk","Jumlah","Total"]];
    state.orders.forEach(o=>{
        ws_data.push([new Date(o.time).toLocaleString('id-ID'), o.buyer, o.name, o.qty, o.total]);
    });
    let ws=XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb,ws,"Laporan");
    XLSX.writeFile(wb, "StockPro_Report.xlsx");
}

// ===== FORM LOGIC =====
document.getElementById("productForm").onsubmit=function(e){
    e.preventDefault();
    const name=document.getElementById("productName").value.trim();
    const cost=parseInt(document.getElementById("productCost").value) || 0;
    const price=parseInt(document.getElementById("productPrice").value) || 0;
    const stock=parseInt(document.getElementById("productStock").value) || 0;
    const editIndex=document.getElementById("editIndex").value;
    
    if(editIndex==="") state.products.push({name, cost, price, stock});
    else state.products[editIndex]={name, cost, price, stock};
    
    this.reset(); document.getElementById("editIndex").value="";
    save(); render();
    showToast("Produk berhasil disimpan!");
}

document.getElementById("saleForm").onsubmit=function(e){
    e.preventDefault();
    const i=parseInt(document.getElementById("productSelect").value);
    const qty=parseInt(document.getElementById("qty").value);
    const buyer=document.getElementById("buyerName").value.trim();
    
    if(state.products[i].stock < qty){ alert("Stok tidak cukup!"); return; }
    
    state.products[i].stock -= qty;
    state.orders.push({
        buyer, name: state.products[i].name, qty, status: "pending", 
        total: state.products[i].price * qty, time: Date.now()
    });
    
    this.reset();
    save(); render();
    showToast("Pesanan masuk! Konfirmasi di halaman Order.");
}

// ===== HELPER FUNCTIONS =====
function editProduct(i){
    const p=state.products[i];
    document.getElementById("productName").value=p.name;
    document.getElementById("productCost").value=p.cost || 0;
    document.getElementById("productPrice").value=p.price;
    document.getElementById("productStock").value=p.stock;
    document.getElementById("editIndex").value=i;
    document.querySelector(".menu a[data-page='addProduct']").click();
}
function deleteProduct(i){ if(confirm("Hapus produk ini?")){ state.products.splice(i,1); save(); render(); } }

function markSold(i){ state.orders[i].status="sold"; save(); render(); showToast("Transaksi Berhasil!"); }
function markCanceled(i){
    const o = state.orders[i];
    const prod = state.products.find(p => p.name === o.name);
    if(prod) prod.stock += o.qty;
    o.status = "canceled";
    save(); render();
    showToast("Pesanan dibatalkan.");
}
function undoOrder(i){
    const o = state.orders[i];
    const prod = state.products.find(p => p.name === o.name);
    if(prod) prod.stock += o.qty;
    state.orders.splice(i,1);
    save(); render();
}

// ===== NAVIGATION =====
const menuLinks=document.querySelectorAll(".menu a");
menuLinks.forEach(link=>{
    link.addEventListener("click",function(e){
        e.preventDefault();
        menuLinks.forEach(l=>l.classList.remove("active"));
        this.classList.add("active");
        document.querySelectorAll(".page").forEach(p=>p.classList.add("d-none"));
        document.getElementById(this.dataset.page).classList.remove("d-none");
        document.getElementById("pageTitle").textContent=this.textContent.trim();
        render();
    });
});

function filterOrders(status, btn){
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const orderTable=document.getElementById('orderTable');
    orderTable.innerHTML='';
    state.orders.map((o,i)=>({...o,index:i})).filter(o=>o.status===status).forEach(o=>{
        let badge=o.status==="pending"?'<span class="badge bg-primary">Memesan</span>':o.status==="sold"?'<span class="badge bg-success">Terjual</span>':'<span class="badge bg-danger">Batal Beli</span>';
        orderTable.innerHTML+=`<tr>
            <td>${o.name}</td><td>${o.buyer}</td><td>${o.qty}</td><td>${badge}</td>
            <td>${o.status==="pending"?`<button class="btn btn-success btn-sm" onclick="markSold(${o.index})">Terjual</button> <button class="btn btn-danger btn-sm" onclick="markCanceled(${o.index})">Batal</button>`:"-"}</td>
        </tr>`;
    });
}

// ===== INIT =====
document.getElementById("todayDate").textContent=new Date().toLocaleDateString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
render();
</script>
</body>
</html>
